<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PR3SI ARCHIVE â€” Trading Journal</title>
<style>
  :root{
    /* LIGHT */
    --bg:#E5EBEF; --card:#ffffff; --text:#222C37; --accent:#927158;
    --profit:#31d07a; --loss:#ff5b6e; --muted:#506173;
    --border:rgba(0,0,0,.14); --shadow:0 8px 30px rgba(0,0,0,.06);
    --chart-grid: rgba(34,44,55,.28); --chart-grid-strong: rgba(34,44,55,.55); --chart-label:#222C37;
  }
  html[data-theme="dark"], body[data-theme="dark"], [data-theme="dark"]{
    /* BRIGHTER DARK */
    --bg:#222C37; --card:#2F3D4D; --text:#FFFFFF; --accent:#60849F;
    --profit:#31d07a; --loss:#ff5b6e; --muted:#E5EBEF;
    --border:rgba(255,255,255,.35); --shadow:0 10px 34px rgba(0,0,0,.55);
    --chart-grid: rgba(229,235,239,.35); --chart-grid-strong: rgba(229,235,239,.65); --chart-label:#FFFFFF;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; transition:background .25s ease,color .25s ease}
  .container{max-width:1280px;margin:0 auto;padding:16px}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0; background:var(--bg); position:sticky; top:0; z-index:10}
  .brand{display:flex; align-items:center; gap:10px}
  .logo{width:14px;height:14px;border-radius:4px;background:var(--accent)}
  .title{font-weight:800; letter-spacing:.08em}
  .btn{cursor:pointer; border:1px solid var(--border); padding:10px 14px; border-radius:12px; background:var(--card); color:var(--text); box-shadow:var(--shadow); transition:transform .12s ease, background .25s ease,color .25s ease}
  .btn:hover{transform:translateY(-1px)}
  .btn.ghost{background:transparent}
  .grid{display:grid; grid-template-columns:1fr; gap:16px}
  @media(min-width:1100px){ .grid{grid-template-columns:minmax(0,1.6fr) minmax(0,.8fr)}}
  .card{background:var(--card); border:1px solid var(--border); box-shadow:var(--shadow); border-radius:16px; padding:14px}
  .card h3{margin:0 0 8px 0; font-size:16px; color:var(--text)}
  .muted{color:var(--muted)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .row > *{flex:0 0 auto}
  .field{display:flex; flex-direction:column; gap:6px}
  label{color:var(--text)}
  input, select, textarea{background:transparent; color:var(--text); border:1.2px solid var(--border); border-radius:12px; padding:10px 12px; outline:none}
  input::placeholder, textarea::placeholder{color:var(--muted); opacity:1}
  .calendar{display:grid; grid-template-columns: repeat(7,1fr); gap:8px}
  .dow{font-size:11px; text-transform:uppercase; text-align:center; color:var(--text)}
  .day{min-height:98px; border:1px dashed var(--border); border-radius:12px; padding:6px; position:relative; overflow:hidden; background:transparent; text-align:left; color:var(--text)}
  .day.today{outline:2px solid var(--accent)}
  .day.selected{border-color:var(--accent); background:rgba(96,132,159,.15); box-shadow:0 0 0 2px rgba(96,132,159,.25) inset}
  .day .date{font-size:12px; color:var(--text)}
  .pnl{position:absolute; bottom:6px; right:8px; font-weight:800}
  .count{position:absolute; top:6px; right:8px; font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid var(--border); color:var(--text)}
  .pnl.pos{color:var(--profit)} .pnl.neg{color:var(--loss)}
  .calendar-nav{display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:12px}
  .calendar-nav .btn{padding:8px 10px}
  #monthLabel{color:var(--text); font-weight:800}
  .stats{display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:10px}
  @media(min-width:700px){.stats{grid-template-columns: repeat(3,minmax(0,1fr))}}
  @media(min-width:1100px){.stats{grid-template-columns: repeat(4,minmax(0,1fr))}}
  .stat{background:transparent; border:1px solid var(--border); border-radius:14px; padding:10px; color:var(--text)}
  .stat .k{font-size:18px; font-weight:800; color:var(--text)}
  .board{display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:8px}
  .rowline{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px 12px; border-radius:12px; background:transparent; border:1px solid var(--border); color:var(--text)}
  .hr{height:1px; background:var(--border); margin:10px 0}
  canvas{width:100%; height:420px; display:block}
  .scroll{max-height:360px; overflow:auto}
  .tag{font-size:10px; padding:3px 8px; border-radius:10px; border:1px solid var(--border); color:var(--text)}
  .chip{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:var(--text)}
  footer{opacity:1; font-size:12px; padding:22px 0 40px; color:var(--text)}
  .modal{position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.5); backdrop-filter:blur(3px)}
  .modal .panel{width:min(520px,92vw)}
  .hidden{display:none !important}
  .two-col{display:grid; grid-template-columns:1fr; gap:10px}
  @media(min-width:700px){.two-col{grid-template-columns: 1fr 1fr}}

  /* === Notebook Journal === */
  .journal-card{position:relative; overflow:hidden; background:linear-gradient(135deg, var(--card) 0%, var(--card) 60%, rgba(0,0,0,.03) 100%); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:0}
  .journal-cover{display:flex; align-items:center; justify-content:space-between; padding:18px 20px; border-bottom:1px dashed var(--border)}
  .journal-cover .label{font-weight:800; letter-spacing:.08em}
  .journal-cover .strap{width:64px; height:14px; background:var(--accent); border-radius:8px}
  .journal-body{display:flex; gap:0}
  .journal-spine{width:22px; background:repeating-linear-gradient( to bottom, var(--accent), var(--accent) 4px, transparent 4px, transparent 8px ); opacity:.35}
  .journal-page{flex:1; min-height:320px; background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,0)), repeating-linear-gradient(#0000, #0000 28px, var(--border) 29px); padding:18px; color:var(--text)}
  .journal-page textarea{width:100%; min-height:260px; border:none; outline:none; background:transparent; resize:vertical; color:var(--text)}
  .page-controls{display:flex; justify-content:space-between; align-items:center; padding:10px 14px; border-top:1px dashed var(--border)}
  .page-tab{display:inline-flex; gap:8px; align-items:center}
  .page-btn{cursor:pointer; border:1px solid var(--border); background:var(--card); color:var(--text); padding:8px 10px; border-radius:10px}
  .thera{padding:12px 16px; border-top:1px solid var(--border); color:var(--text)}

  /* fold/unfold */
  .fold{overflow:hidden; transition:max-height .35s ease, opacity .25s ease; max-height:0; opacity:0}
  .fold.open{max-height:1200px; opacity:1}
  .fold.collapsed{max-height:0; opacity:0}
  .journal-shell .title{font-weight:800; letter-spacing:.08em}
</style>
</head>
<body>
<div id="app">
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div class="title">PR3SI ARCHIVE</div>
      </div>
      <div class="row">
        <button id="themeToggle" class="btn ghost" title="Toggle theme">ðŸŒ“</button>
        <button id="signOut" class="btn ghost">Sign out</button>
      </div>
    </header>

    <section class="card">
      <div class="calendar-nav">
        <button class="btn ghost" id="prevMonth">â—€</button>
        <div id="monthLabel"></div>
        <button class="btn ghost" id="nextMonth">â–¶</button>
      </div>
      <div class="calendar" id="calendar"></div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <label for="rangeSelect">Performance range</label>
          <select id="rangeSelect">
            <option>Weekly</option>
            <option>Biweekly</option>
            <option selected>Monthly</option>
            <option>All-time</option>
          </select>
          <span class="tag" id="rangeWindow"></span>
        </div>
        <div class="row">
          <span class="chip">Profit <b style="color:var(--profit)">â–²</b></span>
          <span class="chip">Loss <b style="color:var(--loss)">â–¼</b></span>
        </div>
      </div>
      <div class="hr"></div>
      <div class="two-col">
        <div>
          <h3>Performance Stats</h3>
          <div class="stats" id="stats"></div>
        </div>
        <div>
          <h3>Ticker Leaderboard</h3>
          <div class="board" id="leader"></div>
        </div>
      </div>
    </section>

    <div class="grid">
      <div class="col-left">
        <section class="card">
          
<h3>COACH PRESI AI</h3>

          <div id="coach" class="muted" style="min-height:64px; color:var(--text)"></div>
        </section>

        <section class="card">
          <h3>Peak Trading Hours (Radial)</h3>
          <canvas id="peakCanvas" width="1200" height="420" aria-label="Peak trading hours radial"></canvas>
          <div id="peakCaption" class="muted" style="font-size:12px;">Clock layout Â· 30â€‘min bins Â· inner ring = 50% win rate Â· green outside, red inside</div>
        </section>

        <section class="card">
          <h3>Rules</h3>
          <div id="rulesList" class="scroll" style="margin-bottom:10px"></div>
          <div class="row">
            <input id="ruleInput" placeholder="Add a rule (e.g., 'No trades after 11:30')" style="flex:1" />
            <input id="rulePass" type="password" placeholder="Account password" style="width:210px" />
            <button id="addRule" class="btn">Save</button>
          </div>
          <div class="muted" style="font-size:12px">To edit/delete rules, password must match your account password.</div>
        </section>
      </div>

      <div class="col-right">
        <section class="card">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3>Daily Trades</h3>
            <div class="muted" id="selectedDateLabel" style="color:var(--text)"></div>
          </div>
          <div class="two-col">
            <form id="tradeForm">
              <div class="field"><label>Date</label><input type="date" id="date" required /></div>
              <div class="field"><label>Ticker</label>
                <select id="ticker" required>
                  <option value="NQ">NQ</option><option value="ES">ES</option>
                  <option value="YM">YM</option><option value="GC">GC</option>
                </select>
              </div>
              <div class="field"><label>Profit/Loss</label><input type="number" id="pnl" step="0.01" placeholder="e.g. 125.50 or -75" required /></div>
              <div class="field"><label>Riskâ€‘Reward</label><input type="number" id="rr" step="0.01" placeholder="e.g. 1.5" required /></div>
              <div class="field"><label>Rules followed?</label>
                <select id="rules" required><option value="yes">Yes</option><option value="no">No</option></select>
              </div>
              <div class="field"><label>Entry (24h)</label><input type="time" id="entry" required /></div>
              <div class="field"><label>Exit (24h)</label><input type="time" id="exit" required /></div>
              <div class="field"><label>Duration (minutes)</label><input type="number" id="duration" min="0" placeholder="auto if blank" /></div>
              <div class="field" style="grid-column:1/-1"><label>Notes</label><textarea id="notes" rows="3" placeholder="Context, emotions, setup..."></textarea></div>
              <div class="row" style="justify-content:flex-end; grid-column:1/-1">
                <input type="hidden" id="editId" />
                <button type="button" id="resetForm" class="btn ghost">Clear</button>
                <button type="submit" class="btn">Save trade</button>
              </div>
            </form>
            <div><div class="scroll" id="tradeList"></div></div>
          </div>
        </section>
      </div>
    </div>

    
<!-- Collapsible Journal at bottom -->
<section class="card journal-shell" id="journalShell">
  <div class="row" style="justify-content:space-between; align-items:center">
    <div class="brand"><div class="logo"></div><div class="title" id="journalCoverTitle">Journal</div></div>
    <div class="row">
      <input id="journalPass" type="password" placeholder="Account password to open" style="width:220px" />
      <button class="btn" id="openJournalBtn">Open journal</button>
    </div>
  </div>
  <div id="journalFold" class="fold collapsed">
    <!-- real notebook appears after open -->
    <h3>Journal</h3>
<section class="journal-card" id="journal">
  <div class="journal-cover">
    <div class="label" id="journalTitle">journal</div>
    <div class="strap"></div>
  </div>
  <div class="journal-body">
    <div class="journal-spine"></div>
    <div class="journal-page">
      <textarea id="journalText" placeholder="Write today's thoughts. Emotions, triggers, gratitude, intentions..."></textarea>
    </div>
  </div>
  <div class="page-controls">
    <div class="page-tab">
      <button class="page-btn" id="prevPage">â—€</button>
      <span class="tag" id="pageInfo"></span>
      <button class="page-btn" id="nextPage">â–¶</button>
    </div>
    <div class="row">
      <button class="btn ghost" id="newPage">New page</button>
      <button class="btn" id="savePage">Save</button>
    </div>
  </div>
  <div class="thera">
    <div class="muted" style="font-size:12px;">THERAPRESI AI</div>
    <div id="theraText" style="margin-top:6px"></div>
  </div>
</section>


  </div>
</section>
<footer class="container">
      <div class="muted" style="color:var(--text)">Built as a clientâ€‘side prototype. Connect a real backend for multiâ€‘device sync.</div>
    </footer>
  </div>

  <div class="modal" id="authModal">
    <div class="panel card">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="title">PR3SI ARCHIVE</div>
        <button id="themeToggle2" class="btn ghost" title="Toggle theme">ðŸŒ“</button>
      </div>
      <div class="muted" style="margin:4px 0 10px 0">Local sign up / sign in. Not secure. Stores to your browser only.</div>
      <form id="authForm" class="two-col">
        <div class="field"><label>Username</label><input id="authUser" required /></div>
        <div class="field"><label>Password</label><input id="authPass" type="password" required /></div>
        <div class="row" style="grid-column:1/-1; justify-content:flex-end">
          <button type="button" class="btn ghost" id="toLogin">Have account? Sign in</button>
          <button type="submit" class="btn" id="authSubmit">Create account</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
/* ===== Storage ===== */
const safeStore = (()=>{ try{ const t='__t__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; }catch(e){ const m=new Map(); return {getItem:k=>m.get(k)||null,setItem:(k,v)=>m.set(k,String(v)),removeItem:k=>m.delete(k)}; } })();
const LS_KEYS = { users:'pr3si_users', active:'pr3si_active_user', theme:'pr3si_theme' };
const todayISO = () => new Date().toISOString().slice(0,10);
const loadUsers = () => { try{return JSON.parse(safeStore.getItem(LS_KEYS.users)||'{}')}catch(e){return{}} };
const saveUsers = (o) => { try{safeStore.setItem(LS_KEYS.users, JSON.stringify(o))}catch(e){} };
const getActive = () => safeStore.getItem(LS_KEYS.active)||'';
const setActive = (u) => u?safeStore.setItem(LS_KEYS.active,u):safeStore.removeItem(LS_KEYS.active);
function userData(){ const u=getActive(); const db=loadUsers(); if(u&&!db[u]) db[u]={pass:'',trades:[],rules:[]}; if(!u&&!db.guest) db.guest={pass:'',trades:[],rules:[]}; return [u||'guest',db,db[u||'guest']]; }

/* ===== Theme ===== */
const app = document.getElementById('app');
function setTheme(t){ document.documentElement.setAttribute('data-theme',t); document.body.setAttribute('data-theme',t); app.setAttribute('data-theme',t); try{safeStore.setItem(LS_KEYS.theme,t)}catch(e){} }
function toggleTheme(){ setTheme((document.documentElement.getAttribute('data-theme')||'dark')==='dark'?'light':'dark'); }
document.getElementById('themeToggle').addEventListener('click',toggleTheme);
document.getElementById('themeToggle2').addEventListener('click',toggleTheme);
setTheme(safeStore.getItem(LS_KEYS.theme) || (document.documentElement.getAttribute('data-theme')||'dark'));

/* ===== Auth ===== */
const authModal = document.getElementById('authModal');
const authForm  = document.getElementById('authForm');
const authUser  = document.getElementById('authUser');
const authPass  = document.getElementById('authPass');
const authSubmit= document.getElementById('authSubmit');
const toLogin   = document.getElementById('toLogin');
let authMode='signup';
function showAuth(){authModal.classList.remove('hidden'); authUser.focus();}
function hideAuth(){authModal.classList.add('hidden');}
function refreshAuthUI(){ getActive()?hideAuth():showAuth(); }
toLogin.addEventListener('click',()=>{ authMode=authMode==='signup'?'login':'signup'; authSubmit.textContent=authMode==='signup'?'Create account':'Sign in'; toLogin.textContent=authMode==='signup'?'Have account? Sign in':'Need account? Sign up'; });
authForm.addEventListener('submit',(e)=>{
  e.preventDefault(); const u=authUser.value.trim(), p=authPass.value;
  if(!u||!p) return; const db=loadUsers();
  if(authMode==='signup'){ if(db[u]) return alert('Username already exists.'); db[u]={pass:p,trades:[],rules:[]}; saveUsers(db); setActive(u); }
  else { if(!db[u]||db[u].pass!==p) return alert('Invalid credentials.'); setActive(u); }
  authForm.reset(); refreshAuthUI(); renderAll();
});
document.getElementById('signOut').addEventListener('click',()=>{ setActive(''); refreshAuthUI(); });

/* ===== Calendar ===== */
const calendarEl = document.getElementById('calendar');
const monthLabel = document.getElementById('monthLabel');
const prevMonth  = document.getElementById('prevMonth');
const nextMonth  = document.getElementById('nextMonth');
const selectedDateLabel = document.getElementById('selectedDateLabel');
let viewDate=new Date(); let selectedDate=todayISO();

function startOfMonth(d){return new Date(d.getFullYear(),d.getMonth(),1)}
function endOfMonth(d){return new Date(d.getFullYear(),d.getMonth()+1,0)}
function fmtMonth(d){return d.toLocaleString(undefined,{month:'long',year:'numeric'})}

function buildCalendar(){
  const [, , me]=userData(); const s=startOfMonth(viewDate), e=endOfMonth(viewDate);
  const startDow=(new Date(s.getFullYear(),s.getMonth(),1)).getDay(); const daysInMonth=e.getDate();
  monthLabel.textContent=fmtMonth(viewDate);
  const dowNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; calendarEl.innerHTML=''; dowNames.forEach(d=>{const div=document.createElement('div'); div.className='dow'; div.textContent=d; calendarEl.appendChild(div)});
  let selectedNode=null;
  for(let i=0;i<startDow;i++){ const pad=document.createElement('div'); calendarEl.appendChild(pad); }
  for(let day=1;day<=daysInMonth;day++){
    const cell=document.createElement('button'); cell.className='day';
    const dISO=new Date(viewDate.getFullYear(),viewDate.getMonth(),day).toISOString().slice(0,10);
    if(dISO===todayISO()) cell.classList.add('today');
    if(dISO===selectedDate){ cell.classList.add('selected'); selectedNode=cell; }
    cell.innerHTML=`<div class="date">${day}</div>`;
    const trades=me.trades.filter(t=>t.date===dISO);
    const pnlSum=trades.reduce((a,b)=>a+Number(b.pnl||0),0);
    if(trades.length){ const b=document.createElement('div'); b.className='count'; b.textContent=trades.length; cell.appendChild(b); }
    if(pnlSum!==0){ const p=document.createElement('div'); p.className='pnl '+(pnlSum>0?'pos':'neg'); p.textContent=(pnlSum>0?'+':'')+pnlSum.toFixed(0); cell.appendChild(p); }
    cell.addEventListener('click',()=>{ if(selectedNode) selectedNode.classList.remove('selected'); cell.classList.add('selected'); selectedNode=cell; selectedDate=dISO; updateDaily(); document.getElementById('date').value=dISO; window.scrollTo({top:0,behavior:'smooth'});});
    calendarEl.appendChild(cell);
  }
}
prevMonth.addEventListener('click',()=>{ viewDate=new Date(viewDate.getFullYear(),viewDate.getMonth()-1,1); buildCalendar(); updateRange(); renderStats(); renderLeader(); drawPeak(); });
nextMonth.addEventListener('click',()=>{ viewDate=new Date(viewDate.getFullYear(),viewDate.getMonth()+1,1); buildCalendar(); updateRange(); renderStats(); renderLeader(); drawPeak(); });

/* ===== Trades ===== */
const tradeForm=document.getElementById('tradeForm'); const tradeList=document.getElementById('tradeList'); const fields=id=>document.getElementById(id);
document.getElementById('resetForm').addEventListener('click',()=>{ tradeForm.reset(); fields('editId').value=''; fields('date').value=selectedDate; });
tradeForm.addEventListener('submit',(e)=>{
  e.preventDefault(); const [u, db, me]=userData(); let dur=Number(fields('duration').value); if(!dur){ dur=minutesBetween(fields('entry').value, fields('exit').value); }
  const payload={ id:fields('editId').value || (crypto.randomUUID?crypto.randomUUID():String(Date.now())), date:fields('date').value, ticker:fields('ticker').value, pnl:Number(fields('pnl').value), rr:Number(fields('rr').value), rules:fields('rules').value==='yes', entry:fields('entry').value, exit:fields('exit').value, duration:Number(dur||0), notes:fields('notes').value.trim() };
  const idx=me.trades.findIndex(t=>t.id===payload.id); if(idx>=0) me.trades[idx]=payload; else me.trades.push(payload); saveUsers(db); tradeForm.reset(); fields('editId').value=''; fields('date').value=selectedDate; renderAll();
});
function minutesBetween(a,b){ if(!a||!b) return 0; const [ah,am]=a.split(':').map(Number), [bh,bm]=b.split(':').map(Number); return ((bh*60+bm)-(ah*60+am)); }

function updateDaily(){ const [, , me]=userData(); selectedDateLabel.textContent=new Date(selectedDate).toLocaleDateString(); fields('date').value=selectedDate; const list=me.trades.filter(t=>t.date===selectedDate).sort((a,b)=>a.entry.localeCompare(b.entry)); tradeList.innerHTML=list.length?'':'<div class="muted">No trades yet.</div>'; list.forEach(t=>{ const card=document.createElement('div'); card.className='rowline'; card.style.flexWrap='wrap'; const info=document.createElement('div'); info.style.flex='1'; const rr = (t.pnl>=0? Math.abs(t.rr) : -Math.abs(t.rr)); info.innerHTML=`<div><b>${t.ticker}</b> Â· <span style="color:${t.pnl>=0?'var(--profit)':'var(--loss)'};font-weight:800">${t.pnl>=0?'+':''}${t.pnl.toFixed(2)}</span> Â· RR ${rr.toFixed(2)} Â· ${t.entry}â†’${t.exit} (${t.duration||0}m) ${t.rules?'<span class="tag">rules</span>':'<span class="tag">broke</span>'}</div><div class="muted" style="font-size:12px;white-space:pre-wrap">${escapeHtml(t.notes||'')}</div>`; const actions=document.createElement('div'); actions.className='row'; const eBtn=document.createElement('button'); eBtn.className='btn ghost'; eBtn.textContent='Edit'; eBtn.onclick=()=>fillForm(t); const dBtn=document.createElement('button'); dBtn.className='btn ghost'; dBtn.textContent='Delete'; dBtn.onclick=()=>delTrade(t.id); actions.appendChild(eBtn); actions.appendChild(dBtn); card.appendChild(info); card.appendChild(actions); tradeList.appendChild(card); }); }
function fillForm(t){ fields('editId').value=t.id; fields('date').value=t.date; fields('ticker').value=t.ticker; fields('pnl').value=t.pnl; fields('rr').value=t.rr; fields('rules').value=t.rules?'yes':'no'; fields('entry').value=t.entry; fields('exit').value=t.exit; fields('duration').value=t.duration||''; fields('notes').value=t.notes||''; window.scrollTo({top:0,behavior:'smooth'}); }
function delTrade(id){ const [, db, me]=userData(); me.trades=me.trades.filter(t=>t.id!==id); saveUsers(db); renderAll(); }

/* ===== Rules (password-gated) ===== */
const rulesList=document.getElementById('rulesList'); const ruleInput=document.getElementById('ruleInput'); const rulePass=document.getElementById('rulePass'); const addRule=document.getElementById('addRule');
function renderRules(){ const [u, db, me]=userData(); rulesList.innerHTML=''; if(!me.rules || !me.rules.length){ rulesList.innerHTML='<div class="muted">No rules yet.</div>'; return; } me.rules.forEach((r,i)=>{ const row=document.createElement('div'); row.className='rowline'; row.innerHTML=`<div style="flex:1">${escapeHtml(r)}</div>`; const e=document.createElement('button'); e.className='btn ghost'; e.textContent='Delete'; e.onclick=()=>{ const [uu, db2, me2]=userData(); if(rulePass.value!==db2[uu].pass) return alert('Wrong password'); me2.rules.splice(i,1); saveUsers(db2); renderRules(); }; row.appendChild(e); rulesList.appendChild(row); }); }
addRule.addEventListener('click',()=>{ const txt=ruleInput.value.trim(); if(!txt) return; const [u, db, me]=userData(); if(rulePass.value!==db[u].pass) return alert('Wrong password'); me.rules = me.rules||[]; me.rules.push(txt); saveUsers(db); ruleInput.value=''; renderRules(); });

/* ===== Range + Stats ===== */
const rangeSelect=document.getElementById('rangeSelect'); const rangeWindow=document.getElementById('rangeWindow');
rangeSelect.addEventListener('change',()=>{ updateRange(); renderStats(); renderLeader(); drawPeak(); });
function getRange(){ const mode=rangeSelect.value; const now=new Date(selectedDate); let start; if(mode==='Weekly'){start=new Date(now); start.setDate(now.getDate()-6);} else if(mode==='Biweekly'){start=new Date(now); start.setDate(now.getDate()-13);} else if(mode==='Monthly'){start=new Date(now.getFullYear(),now.getMonth(),1);} else {start=new Date(0);} const end=new Date(now); end.setHours(23,59,59,999); return {mode,start,end}; }
function updateRange(){ const {start,end}=getRange(); rangeWindow.textContent=`${start.toLocaleDateString()} â€“ ${end.toLocaleDateString()}`; }
function filterByRange(list){ const {start,end}=getRange(); return list.filter(t=>{ const d=new Date(t.date); return d>=start && d<=end; }); }

function dailyPnLMap(rows){ const map=new Map(); rows.forEach(t=>{ const k=t.date; map.set(k,(map.get(k)||0)+Number(t.pnl||0)); }); return map; }
function peakTradingTime(rows){ const bins=binsForRadial(rows); let bestIdx=0, bestVal=-1; for(let i=0;i<bins.winrates.length;i++){ const v=bins.winrates[i]; if(v>bestVal){ bestVal=v; bestIdx=i; } } return bins.labels[bestIdx] || '--:--'; }
function bestTicker(rows){ const sumBy={NQ:0,ES:0,YM:0,GC:0}; rows.forEach(t=>{ if(sumBy[t.ticker]!=null) sumBy[t.ticker]+=Number(t.pnl||0); }); return Object.entries(sumBy).sort((a,b)=>b[1]-a[1])[0][0]; }
function ruleStreak(rows){ const ordered=[...rows].sort((a,b)=> new Date(a.date) - new Date(b.date)); let streak=0; for(let i=ordered.length-1;i>=0;i--){ if(ordered[i].rules) streak++; else break; } return streak; }

function renderStats(){
  const [, , me]=userData(); const rows=filterByRange(me.trades);
  const wins=rows.filter(t=>t.pnl>0), losses=rows.filter(t=>t.pnl<0);
  const winrate=rows.length?(wins.length/rows.length*100):0;
  const avgRR=rows.length? avg(rows.map(x=> (x.pnl>=0? Math.abs(x.rr): -Math.abs(x.rr)) )) : 0;
  const totalPnL=rows.reduce((a,b)=>a+Number(b.pnl||0),0);
  const avgWinDur=wins.length? avg(wins.map(x=>x.duration||0)) : 0;
  const avgLossDur=losses.length? avg(losses.map(x=>x.duration||0)) : 0;
  const bestTime=peakTradingTime(rows);
  const bestTk=bestTicker(rows);
  const byDay=dailyPnLMap(rows); const vals=[...byDay.values()].map(v=>Math.abs(v)); const best=Math.max(0,...vals); const others=vals.filter(v=>v!==best); const consistency = best>0 && others.length? (avg(others)/best*100) : 0;
  const streak=ruleStreak(rows);

  const statEl=document.getElementById('stats'); statEl.innerHTML='';
  const make=(label,val)=>{ const d=document.createElement('div'); d.className='stat'; d.innerHTML=`<div class="muted" style="font-size:12px;color:var(--text)">${label}</div><div class="k">${val}</div>`; statEl.appendChild(d); };
  make('Winrate', `${winrate.toFixed(1)}%`);
  make('Average RR', `${avgRR.toFixed(2)}`);
  make('Peak Time', bestTime);
  make('PnL', `${totalPnL>=0?'+':''}${totalPnL.toFixed(2)}`);
  make('Best Ticker', bestTk);
  make('Avg Win Duration', `${avgWinDur.toFixed(0)}m`);
  make('Avg Loss Duration', `${avgLossDur.toFixed(0)}m`);
  make('Consistency', `${consistency.toFixed(1)}%`);
  make('Rule Streak', `${streak}`);
}

function renderLeader(){
  const [, , me]=userData(); const rows=filterByRange(me.trades);
  const tickers=['NQ','ES','YM','GC']; const el=document.getElementById('leader'); el.innerHTML='';
  tickers.forEach(tk=>{
    const arr=rows.filter(x=>x.ticker===tk);
    const wr=arr.length?(arr.filter(x=>x.pnl>0).length/arr.length*100):0;
    const sum=arr.reduce((a,b)=>a+Number(b.pnl||0),0);
    const line=document.createElement('div'); line.className='rowline';
    line.innerHTML = `<b>${tk}</b><span>${arr.length} trades</span><span style="color:${sum>=0?'var(--profit)':'var(--loss)'}; font-weight:700">${sum>=0?'+':''}${sum.toFixed(0)}</span><span>${wr.toFixed(1)}%</span>`;
    el.appendChild(line);
  });
}
const avg = nums => nums.length? nums.reduce((a,b)=>a+b,0)/nums.length : 0;

/* ===== Peak Trading Hours: radial clock ===== */
const peakCanvas=document.getElementById('peakCanvas'); const ctx=peakCanvas.getContext('2d');
function timeToMin(hhmm){ if(!hhmm) return null; const [h,m]=hhmm.split(':').map(Number); if(Number.isFinite(h)&&Number.isFinite(m)) return h*60+m; return null; }
function minToHHMM(min){ min=((min%1440)+1440)%1440; const h=Math.floor(min/60), m=min%60; return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0'); }
function buildBinsDynamic(list){
  const times=list.map(t=>timeToMin(t.entry)).filter(v=>v!==null).sort((a,b)=>a-b);
  if(!times.length){
    const labels=[]; for(let h=0;h<12;h++){ for(let m=0;m<60;m+=30){ labels.push(String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')); } }
    return {labels, startMin:0};
  }
  const minT=Math.max(0, times[0]-60);
  const maxT=Math.min(1430, times[times.length-1]+60);
  const startMin = Math.floor(minT/30)*30;
  const endMin   = Math.ceil(maxT/30)*30;
  const labels=[]; for(let m=startMin; m<=endMin; m+=30){ labels.push(minToHHMM(m)); }
  return {labels, startMin};
}
function binsForRadial(list){
  const {labels,startMin}=buildBinsDynamic(list);
  const n=labels.length; const counts=new Array(n).fill(0), wins=new Array(n).fill(0);
  list.forEach(t=>{ const mins=timeToMin(t.entry); if(mins==null) return; const idx=Math.min(n-1, Math.max(0, Math.floor((mins-startMin)/30))); counts[idx]++; if(t.pnl>0) wins[idx]++; });
  const winrates=counts.map((c,i)=> c? (wins[i]/c)*100 : 0);
  return {labels, counts, wins, winrates};
}
function drawPeak(){
  const [, , me]=userData(); const rows=filterByRange(me.trades); const {labels,winrates}=binsForRadial(rows);
  const caption=document.getElementById('peakCaption');
  if(caption){ caption.textContent = labels.length? `${labels[0]}â€“${labels[labels.length-1]} Â· clock layout Â· inner ring = 50% win` : 'Clock layout Â· inner ring = 50% win'; }
  const rect=peakCanvas.getBoundingClientRect(); peakCanvas.width=Math.max(420, Math.floor(rect.width));
  const W=peakCanvas.width, H=peakCanvas.height; ctx.clearRect(0,0,W,H);
  const cx=W/2, cy=H/2; const outer=Math.min(W,H)*0.38; const inner=outer*0.5; const baseRadius=outer*0.2; const labelRadius=outer*1.08;
  // Grid
  ctx.strokeStyle=getCss('--chart-grid'); ctx.lineWidth=1.5;
  ;[outer,(inner+outer)/2,inner,(inner+baseRadius)/2,baseRadius].forEach(r=>{ ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke(); });
  // Hour ticks
  ctx.strokeStyle=getCss('--chart-grid-strong'); ctx.lineWidth=2; const n=labels.length; const step=(Math.PI*2)/Math.max(1,n);
  for(let i=0;i<n;i+=2){ const ang=-Math.PI/2 + i*step; const r1=outer*1.00, r2=outer*1.06; ctx.beginPath(); ctx.moveTo(cx+Math.cos(ang)*r1, cy+Math.sin(ang)*r1); ctx.lineTo(cx+Math.cos(ang)*r2, cy+Math.sin(ang)*r2); ctx.stroke(); }
  // Labels
  ctx.fillStyle=getCss('--chart-label'); ctx.font='12px Inter, system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
  const labelStep=Math.max(1, Math.round(n/10)); // ~10 labels
  for(let i=0;i<n;i+=labelStep){ const ang=-Math.PI/2 + i*step; ctx.fillText(labels[i], cx+Math.cos(ang)*labelRadius, cy+Math.sin(ang)*labelRadius); }
  // Data
  const pts=[]; let bestIdx=0, bestWR=-1;
  for(let i=0;i<n;i++){ const wr=winrates[i]; if(wr>bestWR){ bestWR=wr; bestIdx=i; } const t=-Math.PI/2 + i*step; const r=baseRadius + (wr/100)*(outer-baseRadius); pts.push([cx+Math.cos(t)*r, cy+Math.sin(t)*r, wr, t, r]); }
  ctx.lineWidth=3;
  for(let i=0;i<n;i++){ const j=(i+1)%n; const [x1,y1,wr1,t1,r1]=pts[i]||[cx,cy,0,0,baseRadius], [x2,y2,wr2,t2,r2]=pts[j]||[cx,cy,0,0,baseRadius]; const c1x=cx+Math.cos(t1)*(r1+inner)/2, c1y=cy+Math.sin(t1)*(r1+inner)/2, c2x=cx+Math.cos(t2)*(r2+inner)/2, c2y=cy+Math.sin(t2)*(r2+inner)/2; const mid=(wr1+wr2)/2; ctx.strokeStyle = mid>=50 ? getCss('--profit') : mid<=50 ? getCss('--loss') : getCss('--chart-grid-strong'); ctx.beginPath(); ctx.moveTo(x1,y1); ctx.bezierCurveTo(c1x,c1y,c2x,c2y,x2,y2); ctx.stroke(); }
  // 50% ring
  ctx.setLineDash([5,4]); ctx.strokeStyle=getCss('--chart-grid-strong'); ctx.beginPath(); ctx.arc(cx,cy, baseRadius + 0.5*(outer-baseRadius), 0, Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
  // Center + best marker
  ctx.fillStyle=getCss('--accent'); ctx.beginPath(); ctx.arc(cx,cy,4,0,Math.PI*2); ctx.fill();
  if(pts.length){ const [,,,tBest,rBest]=pts[bestIdx]; ctx.fillStyle=getCss('--chart-label'); ctx.beginPath(); ctx.arc(cx+Math.cos(tBest)*rBest, cy+Math.sin(tBest)*rBest, 4, 0, Math.PI*2); ctx.fill(); }
}


/* ===== Journal + TheraPRESI AI ===== */
const JKEY = 'pr3si_journal';
function loadJournal(){ try{return JSON.parse(safeStore.getItem(JKEY)||'{}')}catch(e){return{}} }
function saveJournal(obj){ try{safeStore.setItem(JKEY, JSON.stringify(obj))}catch(e){} }
let pageIndex = 0; // 0-based
function journalPages(){ const [u]=userData(); const db=loadJournal(); db[u]=db[u]||{pages:[{title:'Page 1', text:''}]}; saveJournal(db); return db; }
function currentPageSet(){ const [u]=userData(); const db=journalPages(); return [db, db[u]]; }
function renderJournal(){
  const [u]=userData(); document.getElementById('journalTitle').textContent = `${u || 'guest'}'s journal`;
  const [db, me] = currentPageSet();
  const pages = me.pages;
  if(pageIndex<0) pageIndex=0; if(pageIndex>=pages.length) pageIndex=pages.length-1;
  document.getElementById('journalText').value = pages[pageIndex].text || '';
  document.getElementById('pageInfo').textContent = `Page ${pageIndex+1} / ${pages.length}`;
  runThera(); // update advice
}
document.getElementById('savePage').addEventListener('click',()=>{
  const [u]=userData(); const db=journalPages(); const text=document.getElementById('journalText').value;
  db[u].pages[pageIndex].text = text;
  // auto-title: first non-empty line or date
  const firstLine = (text.split(/\n/).find(l=>l.trim().length) || new Date().toLocaleDateString()).trim();
  db[u].pages[pageIndex].title = firstLine.slice(0,48);
  saveJournal(db); renderJournal();
});
document.getElementById('newPage').addEventListener('click',()=>{
  const [u]=userData(); const db=journalPages(); db[u].pages.push({title:`Page ${db[u].pages.length+1}`, text:''}); pageIndex=db[u].pages.length-1; saveJournal(db); renderJournal();
});
document.getElementById('prevPage').addEventListener('click',()=>{ pageIndex=Math.max(0, pageIndex-1); renderJournal(); });
document.getElementById('nextPage').addEventListener('click',()=>{ const [,me]=currentPageSet(); pageIndex=Math.min(me.pages.length-1, pageIndex+1); renderJournal(); });

function sentimentScore(text){
  const lows = ['angry','mad','rage','revenge','fomo','tilt','fear','anxious','panic','sad','tired','exhausted','overtrade','loss','lose','lost','break rules','broke rules','impulse','frustrated','stress'];
  const highs = ['grateful','calm','patient','disciplined','focused','confident','flow','present','wins','clarity','good sleep','hydrated','prayer','peace'];
  let s=0; const t=text.toLowerCase();
  lows.forEach(w=>{ if(t.includes(w)) s-=2; });
  highs.forEach(w=>{ if(t.includes(w)) s+=2; });
  // mild nudge for punctuation tempo
  if((t.match(/!/g)||[]).length>2) s-=1;
  return s;
}
function runThera(){
  const txt=document.getElementById('journalText').value||'';
  const s=sentimentScore(txt);
  const tipsGood=[
    'Keep the pace. Journal 3 bullets before session: intention, risk cap, A+ triggers.',
    'Use that calm: widen patience, not risk. Wait for named setups only.',
    'Bank the win, protect the mind: stop after two A+ wins or 3R.',
    'Track what worked today â€” make it repeatable tomorrow.'
  ];
  const tipsMid=[
    'Shorten the session. 90 minutes of Aâ€‘game beats 5 hours of drift.',
    'Reset ritual: water, 10 breaths, reâ€‘read rules.',
    'Trade the plan you wrote, or donâ€™t trade.',
    'If emotions flicker, cut size in half for the next trade.'
  ];
  const tipsLow=[
    'Your nervous system is loud today. Flat is a position. Sit out or sim trade.',
    'Tighten risk: quarter size, single attempt per setup.',
    'Microâ€‘win target: follow rules for one clean session, PnL secondary.',
    'Step away if you feel chase or revenge â€” screens wonâ€™t heal frustration.'
  ];
  let pick = tipsMid;
  if(s>=3) pick=tipsGood; else if(s<=-2) pick=tipsLow;
  const quoteBank=[
    'Discipline builds freedom.',
    'Process > outcome.',
    'Patience is a position.',
    'Edge + restraint = compounding.'
  ];
  const line = pick[Math.floor(Math.random()*pick.length)];
  const q = quoteBank[Math.floor(Math.random()*quoteBank.length)];
  document.getElementById('theraText').textContent = `${line}  â€¢  ${q}`;
}
document.getElementById('journalText').addEventListener('input', ()=>{ // live autosave with debounce
  clearTimeout(window.__jdeb); window.__jdeb=setTimeout(()=>document.getElementById('savePage').click(), 600);
});


/* ===== Journal gate at bottom ===== */
const journalShell = document.getElementById('journalShell');
const openJournalBtn = document.getElementById('openJournalBtn');
const journalFold = document.getElementById('journalFold');
const journalPass = document.getElementById('journalPass');
const journalCoverTitle = document.getElementById('journalCoverTitle');

function setJournalCover(){
  const [u]=userData();
  journalCoverTitle.textContent = `${u || 'guest'}'s journal`;
}
setJournalCover();

openJournalBtn.addEventListener('click', ()=>{
  const [u, db] = userData();
  if((db[u||'guest']?.pass || '') !== journalPass.value){
    alert('Wrong password'); return;
  }
  journalPass.value='';
  journalFold.classList.remove('collapsed');
  journalFold.classList.add('open');
  // ensure journal content renders now (pages might rely on DOM)
  renderJournal();
  journalFold.scrollIntoView({behavior:'smooth', block:'start'});
});
/* ===== Coach: richer variety tied to stats ===== */
function analyzeAndCoach(){
  const [, , me]=userData(); const rows=filterByRange(me.trades);
  const wins=rows.filter(t=>t.pnl>0), losses=rows.filter(t=>t.pnl<0);
  const wr=rows.length?(wins.length/rows.length*100):0;
  const rrAvg=rows.length? avg(rows.map(x=> (x.pnl>=0? Math.abs(x.rr): -Math.abs(x.rr)) )) : 0;
  const broke=rows.filter(t=>!t.rules).length;
  const avgDurWin=wins.length? avg(wins.map(x=>x.duration||0)) : 0;
  const avgDurLoss=losses.length? avg(losses.map(x=>x.duration||0)) : 0;
  const pnl=rows.reduce((a,b)=>a+Number(b.pnl||0),0);
  const msgs=[];

  if(wr<35 && rows.length>=10) msgs.push('Edge looks cold â€” drop to half size and take only A+ patterns for 1 week.');
  if(rrAvg<1) msgs.push('RR < 1 on average â€” let the noâ€‘reward trades pass. Wait for 1.5R+ structures.');
  if(broke>=2) msgs.push('Rules breaking appears â€” write a preâ€‘trade checklist and verbalize before click.');
  if(avgDurLoss>avgDurWin+5) msgs.push('Losses are held longer than wins â€” invert that. Cut losers faster.');
  if(pnl>0 && wr>=50) msgs.push('Solid execution â€” bank it early; stopping green protects your edge.');
  if(rows.length>=8 && wr>=55 && rrAvg>=1.5) msgs.push('Stats trending strong â€” consider scaling size incrementally (+10%) next week.');
  if(!msgs.length) msgs.push('Keep it steady: protect the down days, let the math work.');

  const quotes=[
    'Boredom is not a signal.',
    'You donâ€™t control outcome; you control entry, size, and exit.',
    'Flat is a position.',
    'Trade less, profit more.'
  ];
  const final = `${msgs[Math.floor(Math.random()*msgs.length)]}  â€” ${quotes[Math.floor(Math.random()*quotes.length)]}`;
  coach.textContent = final;
}

/* ===== Coach ===== */
const coach=document.getElementById('coach'); const coachQuotes=['Discipline > impulse.','Protect capital. Give futureâ€‘you a gift.','Small edge + big patience = compounding.','No setup? No trade. Boredom is not a signal.','Cut losers quick. Let the stats work.','Screens donâ€™t owe you. You choose risk.','Process is the product.','Aâ€‘game only. Câ€‘game sits out.'];
function analyzeAndCoach(){
  const [, , me]=userData(); const rows=filterByRange(me.trades);
  const wins=rows.filter(t=>t.pnl>0), losses=rows.filter(t=>t.pnl<0);
  const wr=rows.length?(wins.length/rows.length*100):0;
  const rrAvg=rows.length? avg(rows.map(x=> (x.pnl>=0? Math.abs(x.rr): -Math.abs(x.rr)) )) : 0;
  const broke=rows.filter(t=>!t.rules).length;
  let msg=coachQuotes[Math.floor(Math.random()*coachQuotes.length)];
  const lastNotes=rows.slice(-8).map(t=>String(t.notes||'').toLowerCase()).join(' ');
  if(/angry|mad|rage|heated/.test(lastNotes)) msg='You lose more when heated â€” step away when angry.';
  else if(/tired|sleep|exhaust/.test(lastNotes)) msg='Tired = leaks. Shorten sessions or skip.';
  else if(/fomo|chase|revenge/.test(lastNotes)) msg='No chasing. Only named setups.';
  else if(broke>=3) msg='Rules slipping. Trade half size until 5 ruleâ€‘clean sessions.';
  else if(wr<40 && rows.length>=8) msg='Edge looks cold. Cut size, tighten A+ filter.';
  else if(rrAvg<1 && rows.length>=8) msg='RR < 1 is dragging. Pass on lowâ€‘RR plays for a week.';
  coach.textContent = `${msg}  WR ${wr.toFixed(0)}% Â· Avg RR ${rrAvg.toFixed(2)} Â· ${broke} rule breaks.`;
}
setInterval(analyzeAndCoach, 90*1000);

/* ===== Render & Init ===== */
function renderAll(){ buildCalendar(); updateRange(); renderStats(); renderLeader(); renderRules(); updateDaily(); drawPeak(); setJournalCover(); renderJournal(); analyzeAndCoach(); }
(function init(){ refreshAuthUI(); selectedDate=todayISO(); renderAll(); })();
window.addEventListener('resize', drawPeak);

/* ===== Utils ===== */
function getCss(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
</script>
</body>
</html>
